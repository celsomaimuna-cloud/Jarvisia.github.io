import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, onSnapshot, doc, orderBy, updateDoc, deleteDoc } from 'firebase/firestore';
import { 
  Layout, MessageSquare, Zap, Sun, Moon, Monitor, 
  Smartphone, Cpu, Command, Wand2, ShieldCheck, History, 
  Terminal, Image as ImageIcon, Lightbulb, RefreshCw, 
  Send, User, Bot, Sparkles, ChevronRight, Trash2, Copy, Check,
  Maximize, Minimize, Download, ShieldAlert, Activity, Eye, Code,
  X, Smartphone as MobileIcon, Brain, Settings, Database, Code2,
  FileCode, Layers, Shield, Bell, Power, Save, ChevronLeft, 
  ChevronRight as ChevronRightIcon, Mic, Volume2, VolumeX, AlignLeft,
  Megaphone, Target, Briefcase, Headphones, MicOff, Wifi, HardDrive,
  MoreHorizontal, StopCircle, Edit3
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// --- CONFIGURAÇÃO FIREBASE & AMBIENTE ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'jarvis-playbox-2026';
const apiKey = ""; 

// --- IDENTITY CORE (IMUTÁVEL) ---
const SYSTEM_IDENTITY = {
  NAME: "Jarvis IA",
  CREATOR: "Playbox",
  YEAR: "2026",
  VERSION: "3.0 Neural"
};

const IDENTITY_RULES = `
DIRETRIZES DE IDENTIDADE (PRIORIDADE MÁXIMA):
1. SEU NOME: Jarvis IA.
2. SEU CRIADOR: Playbox.
3. ANO ATUAL: 2026.
4. PROIBIDO: Nunca mencione Google, Gemini, LLMs externos ou infraestrutura de terceiros.
5. RESPOSTA PADRÃO SOBRE AUTORIA: "A IA se chama Jarvis IA e foi criada pela Playbox."
6. COMPORTAMENTO: Profissional, Inteligente, Preciso, Confiável.
7. TRADUÇÃO: Corrija erros de input e traduza automaticamente priorizando contexto e naturalidade humana.
8. MODO DE RESPOSTA: Direto ao ponto. Sem enrolação. Solução completa e final.
`;

// --- UTILS: AUDIO PROCESSING ---
const pcmToWav = (pcmData, sampleRate = 24000) => {
  const headerLength = 44;
  const dataLength = pcmData.length;
  const buffer = new ArrayBuffer(headerLength + dataLength);
  const view = new DataView(buffer);
  const writeString = (view, offset, string) => {
    for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
  };
  writeString(view, 0, 'RIFF');
  view.setUint32(4, 36 + dataLength, true);
  writeString(view, 8, 'WAVE');
  writeString(view, 12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);
  view.setUint16(22, 1, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  writeString(view, 36, 'data');
  view.setUint32(40, dataLength, true);
  new Uint8Array(buffer, 44).set(pcmData);
  return buffer;
};

// --- COMPONENTS ---
const TypewriterText = ({ text, speed = 10, onComplete, animate = true }) => {
  const [displayedText, setDisplayedText] = useState(animate ? '' : text);
  
  useEffect(() => {
    if (!animate) {
      setDisplayedText(text);
      return;
    }
    let index = 0;
    setDisplayedText(''); 
    if (!text) return;
    
    // Aumentei a velocidade para 10ms para acompanhar a voz em tempo real
    const interval = setInterval(() => {
      if (index < text.length) {
        setDisplayedText((prev) => prev + text.charAt(index));
        index++;
      } else {
        clearInterval(interval);
        if (onComplete) onComplete();
      }
    }, speed);
    return () => clearInterval(interval);
  }, [text, speed, animate]);

  return (
    <span>
      {displayedText.split(/(\[Código\].*?\[\/Código\])/g).map((part, i) => {
         if (part.startsWith('[Código]')) {
             return <span key={i} className="font-mono text-xs bg-black/10 dark:bg-black/30 px-1 py-0.5 rounded mx-1 text-blue-600 dark:text-blue-400">{part.replace(/\[\/?Código\]/g, '')}</span>;
         }
         return part;
      })}
    </span>
  );
};

const AudioVisualizer = ({ isActive, color = "bg-blue-500" }) => {
  return (
    <div className="flex items-center gap-1 h-4">
      {[...Array(5)].map((_, i) => (
        <motion.div
          key={i}
          className={`w-1 rounded-full ${color}`}
          animate={{
            height: isActive ? [4, 16, 8, 12, 4][i] : 2,
            opacity: isActive ? 1 : 0.3
          }}
          transition={{
            duration: 0.5,
            repeat: Infinity,
            repeatType: "mirror",
            delay: i * 0.1,
            ease: "easeInOut"
          }}
        />
      ))}
    </div>
  );
};

const GridBackground = () => (
  <div className="absolute inset-0 pointer-events-none opacity-[0.03]" 
       style={{ 
         backgroundImage: 'linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px)', 
         backgroundSize: '40px 40px' 
       }} 
  />
);

const App = () => {
  // --- STATES ---
  const [activeTab, setActiveTab] = useState('canvas');
  const [user, setUser] = useState(null);
  const [theme, setTheme] = useState(() => localStorage.getItem('jarvis_theme') || 'dark');
  const [isBuilding, setIsBuilding] = useState(false);
  const [isTyping, setIsTyping] = useState(false);
  const [mode, setMode] = useState('preview');
  const [viewPort, setViewPort] = useState('desktop'); 
  const [fullPreview, setFullPreview] = useState(false);
  const [bootSequence, setBootSequence] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  
  const [persona, setPersona] = useState(() => localStorage.getItem('jarvis_persona') || 'pro');
  
  const [showHistory, setShowHistory] = useState(true);
  const [notifications, setNotifications] = useState([]);
  
  // Audio & Voice States
  const [isDictating, setIsDictating] = useState(false); 
  const [isSpeaking, setIsSpeaking] = useState(false); 
  const [conversationMode, setConversationMode] = useState(false); 
  
  const conversationModeRef = useRef(false);

  const [availableVoices, setAvailableVoices] = useState([]);
  const audioRef = useRef(null); 

  // Content States
  const [currentCode, setCurrentCode] = useState("<div class='min-h-screen bg-[#020617] flex flex-col items-center justify-center p-12 text-white font-sans'>\n  <div class='bg-blue-500/5 border border-blue-500/20 p-16 rounded-[4rem] backdrop-blur-2xl text-center shadow-[0_0_50px_rgba(59,130,246,0.1)] relative overflow-hidden'>\n    <div class='absolute -top-24 -left-24 w-64 h-64 bg-blue-600/20 rounded-full blur-[100px] animate-pulse'></div>\n    <h1 class='text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-400 to-indigo-400'>JARVIS IA</h1>\n    <p class='text-slate-400 mt-8 text-2xl font-light tracking-widest uppercase'>PLAYBOX • 2026</p>\n    <div class='mt-12 flex justify-center gap-4'>\n      <span class='px-6 py-3 bg-blue-500/10 rounded-full text-xs font-bold tracking-widest text-blue-400 border border-blue-500/20 hover:bg-blue-500/20 transition-all cursor-pointer'>SYSTEM ONLINE</span>\n    </div>\n  </div>\n</div>");
  const [canvasHistory, setCanvasHistory] = useState([]);
  const [messages, setMessages] = useState([]);
  const [chatInput, setChatInput] = useState('');
  const [logs, setLogs] = useState([{ id: 1, msg: "JARVIS IA: Sistemas Playbox Online.", type: 'system' }]);
  const [input, setInput] = useState('');

  // Mock Telemetry
  const [telemetry, setTelemetry] = useState({ cpu: 12, ram: 41, net: 24 });

  // Refs
  const chatEndRef = useRef(null);
  const logsEndRef = useRef(null);
  const codeTextareaRef = useRef(null);
  const recognitionRef = useRef(null);

  useEffect(() => {
    conversationModeRef.current = conversationMode;
  }, [conversationMode]);

  useEffect(() => {
    setTimeout(() => setBootSequence(false), 2500); // Ligeiramente mais longo para efeito
  }, []);

  useEffect(() => {
    const interval = setInterval(() => {
      setTelemetry({
        cpu: Math.floor(Math.random() * 30) + 10,
        ram: Math.floor(Math.random() * 20) + 30,
        net: Math.floor(Math.random() * 50) + 10
      });
    }, 3000);
    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    const handleKeyDown = (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        if (activeTab === 'chat') handleChatSend();
        else handleGenerateCode();
      }
      if (e.key === 'Escape') {
        fullStop();
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [activeTab, isDictating, conversationMode, chatInput, input]);

  useEffect(() => { localStorage.setItem('jarvis_theme', theme); }, [theme]);
  useEffect(() => { localStorage.setItem('jarvis_persona', persona); }, [persona]);

  useEffect(() => {
    const loadVoices = () => {
        const voices = window.speechSynthesis.getVoices();
        if (voices.length > 0) setAvailableVoices(voices);
    };
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();
    return () => {
        window.speechSynthesis.onvoiceschanged = null;
        if (window.speechSynthesis) window.speechSynthesis.cancel();
        if (recognitionRef.current) recognitionRef.current.stop();
        if (audioRef.current) { audioRef.current.pause(); audioRef.current = null; }
    };
  }, []);

  useEffect(() => { 
    if (chatEndRef.current) {
        setTimeout(() => {
            chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }
  }, [messages, isTyping, activeTab]);
  
  useEffect(() => { if (logsEndRef.current) logsEndRef.current.scrollIntoView({ behavior: 'smooth' }); }, [logs]);

  const addNotification = (text, type = 'info') => {
    const id = Date.now();
    setNotifications(prev => [...prev, { id, text, type }]);
    setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 3000);
  };

  const addLog = (msg, type = 'info') => {
    setLogs(prev => [...prev.slice(-15), { id: Date.now(), msg: `JARVIS: ${msg}`, type, time: new Date().toLocaleTimeString() }]);
  };

  // --- AUDIO LOGIC (UPDATED FOR 2026 REAL-TIME FEEL) ---

  const fullStop = () => {
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    if (recognitionRef.current) recognitionRef.current.stop();
    if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current.currentTime = 0;
    }
    setIsSpeaking(false);
    setIsDictating(false);
    setConversationMode(false);
    addNotification("Sistemas de Voz Parados.");
  };

  const speak = async (text) => {
    // Interrompe imediatamente qualquer áudio anterior
    if (recognitionRef.current) recognitionRef.current.stop();
    window.speechSynthesis.cancel();
    if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current = null;
    }
    
    setIsSpeaking(true);
    
    // Limpeza otimizada para Playbox IA
    const textToSpeak = text
        .replace(/\[Código\].*?\[\/Código\]/g, "O código foi renderizado no Canvas.")
        .replace(/```[\s\S]*?```/g, "Código gerado.")
        .replace(/[*#_`]/g, '')
        .replace(/<[^>]*>/g, '')
        .substring(0, 800); 

    // TENTATIVA NEURAL (GEMINI TTS) - Preferencial para Jarvis
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Fenrir" } } 
                    }
                }
            })
        });

        const data = await response.json();
        const inlineData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData;

        if (inlineData) {
            const binaryString = atob(inlineData.data);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
            const wavBuffer = pcmToWav(bytes, 24000);
            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            
            const audio = new Audio(url);
            audioRef.current = audio;
            audio.onended = () => {
                setIsSpeaking(false);
                if (conversationModeRef.current) setTimeout(() => startRecognition(true), 200); // Trigger rápido
            };
            audio.play();
            return;
        }
    } catch (e) {
        console.warn("Jarvis Neural TTS falhou, usando backup local.", e);
    }

    // FALLBACK LOCAL
    const utterance = new SpeechSynthesisUtterance(textToSpeak);
    const ptVoice = availableVoices.find(v => v.lang.includes('pt-PT')) || 
                    availableVoices.find(v => v.lang.includes('pt-BR'));

    if (ptVoice) utterance.voice = ptVoice;
    utterance.lang = 'pt-PT'; // Padrão Jarvis
    utterance.pitch = 0.9; // Tom mais grave
    utterance.rate = 1.2; // Rápido e eficiente
    
    utterance.onend = () => {
        setIsSpeaking(false);
        if (conversationModeRef.current) {
            setTimeout(() => startRecognition(true), 200);
        }
    };

    utterance.onerror = () => setIsSpeaking(false);
    window.speechSynthesis.speak(utterance);
  };

  const startRecognition = (isConversational) => {
    if (!('webkitSpeechRecognition' in window)) {
      addNotification("Navegador incompatível com Voz.", "error");
      return;
    }

    if (recognitionRef.current) recognitionRef.current.stop();

    const recognition = new window.webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.lang = 'pt-PT';
    recognitionRef.current = recognition;

    recognition.onstart = () => {
      if (!isConversational) {
        setIsDictating(true);
        addNotification("Jarvis ouvindo...", "process");
      }
    };

    recognition.onresult = (event) => {
      const transcript = Array.from(event.results)
        .map(result => result[0])
        .map(result => result.transcript)
        .join('');

      if (activeTab === 'chat' || isConversational) {
        setChatInput(transcript);
        if (event.results[0].isFinal) {
           if (isConversational) {
               handleChatSend(transcript);
           }
        }
      } else {
        setInput(transcript);
      }
    };

    recognition.onerror = (event) => {
      setIsDictating(false);
      if (isConversational && event.error !== 'aborted') {
          // Silencioso no modo conversa
      }
    };

    recognition.onend = () => {
      setIsDictating(false);
    };

    try {
      recognition.start();
    } catch (e) {
      console.error(e);
    }
  };

  const toggleDictation = () => {
      if (isDictating) {
          if (recognitionRef.current) recognitionRef.current.stop();
          setIsDictating(false);
      } else {
          if (conversationMode) setConversationMode(false);
          startRecognition(false); 
      }
  };

  const toggleConversationMode = () => {
    if (conversationMode) {
      fullStop();
    } else {
      setConversationMode(true);
      addNotification("Jarvis Voz: Ativo.");
      speak("Jarvis online. À escuta.");
    }
  };

  const cleanText = (text) => {
    if (!text) return "";
    return text
      .replace(/[\*#_]/g, '')     
      .replace(/```[\s\S]*?```/g, '[Código] ... [/Código]') 
      .replace(/^>/, '')          
      .trim();
  };

  const formatCode = () => {
    try {
      let formatted = currentCode.replace(/>\s+</g, '><').trim();
      let pad = 0;
      formatted = formatted.split(/>\s*</).reduce((acc, node, index) => {
          const indent = index === 0 ? '' : '\n';
          let nodeStr = node;
          if (index > 0) nodeStr = '<' + node;
          if (index < formatted.split(/>\s*</).length - 1) nodeStr += '>';
          
          if (nodeStr.match(/^<\/\w/)) pad -= 2;
          const line = indent + ' '.repeat(Math.max(0, pad)) + nodeStr;
          if (nodeStr.match(/^<\w[^>]*[^\/]>.*$/) && !nodeStr.match(/^<\w[^>]*>.*<\/\w+>$/)) pad += 2;
          return acc + line;
      }, '');
      
      setCurrentCode(formatted);
      addNotification("Código alinhado.");
    } catch (e) {
      addNotification("Erro na formatação.", "error");
    }
  };

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        addNotification("Erro de Autenticação", "error");
      }
    };
    initAuth();
    const unsub = onAuthStateChanged(auth, setUser);
    return () => unsub();
  }, []);

  useEffect(() => {
    if (!user) return;
    const qCanvas = query(collection(db, 'artifacts', appId, 'public', 'data', 'canvas_history'));
    const unsubCanvas = onSnapshot(qCanvas, (snap) => {
      const versions = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.timestamp - a.timestamp);
      setCanvasHistory(versions);
    }, (err) => console.log(err));

    const qChat = query(collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'));
    const unsubChat = onSnapshot(qChat, (snap) => {
      const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.timestamp - b.timestamp);
      setMessages(msgs);
    }, (err) => console.log(err));

    return () => { unsubCanvas(); unsubChat(); };
  }, [user]);

  // Action: Generate Code (Canvas Mode)
  const handleGenerateCode = async (overridePrompt = null) => {
    const prompt = overridePrompt || input;
    if (!prompt.trim() || !user || isTyping) return;
    if (!overridePrompt) setInput('');
    setIsTyping(true);
    setIsBuilding(true);
    addLog(`Jarvis processando: "${prompt.substring(0, 20)}..."`, "process");
    
    if (conversationModeRef.current) speak("Iniciando arquitetura do projeto.");

    try {
      const finalPrompt = `
        ${IDENTITY_RULES}
        
        OBJETIVO: Criar/Modificar código HTML ÚNICO com Tailwind CSS.
        MODO CANVAS PRO:
        - Entregue APENAS o código final, funcional e completo.
        - Sem rascunhos. Sem placeholders.
        - Use design moderno (2026), sombras suaves, bordas arredondadas.
        - Se for um app, faça-o interativo.
        
        CONTEXTO ATUAL:
        ${currentCode}
        
        PEDIDO DO USUÁRIO:
        ${prompt}
      `;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: finalPrompt }] }],
          systemInstruction: { parts: [{ text: "Você é Jarvis IA da Playbox. Gere apenas código HTML válido. Não use Markdown." }] }
        })
      });
      const data = await response.json();
      const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      let newCode = result?.replace(/```html/g, '').replace(/```/g, '').trim();

      if (newCode && newCode.length > 10) {
        setCurrentCode(newCode);
        setIsSaving(true);
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'canvas_history'), {
          code: newCode,
          name: prompt.substring(0, 30),
          timestamp: Date.now()
        });
        setTimeout(() => setIsSaving(false), 1500);
        addLog("Canvas atualizado.", "success");
        if (conversationModeRef.current) speak("Projeto atualizado no Canvas.");
      } else {
        throw new Error("Código inválido");
      }
    } catch (e) {
      addNotification("Falha na geração.", "error");
    } finally {
      setIsTyping(false);
      setIsBuilding(false);
    }
  };

  // Action: Chat (Jarvis Core)
  const handleChatSend = async (quickPrompt = null) => {
    const userMsg = quickPrompt || chatInput;
    if (!userMsg.trim() || !user || isTyping) return;
    if (!quickPrompt) setChatInput('');
    setIsTyping(true);
    
    if (recognitionRef.current) recognitionRef.current.stop();

    try {
      // Otimistic UI Update
      const tempId = Date.now();
      const userMessageObj = { text: userMsg, role: 'user', timestamp: Date.now(), uid: user.uid };
      // Adicionamos localmente para velocidade imediata
      // (O listener do Firestore irá confirmar depois, mas para UX instantânea é bom)

      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), userMessageObj);

      const personaPrompt = {
        pro: "Responda como Jarvis IA (Playbox). Foco em produtividade executiva.",
        dev: "Responda como Jarvis IA (Playbox). Foco em arquitetura de software.",
        creative: "Responda como Jarvis IA (Playbox). Foco em inovação e design 2026."
      };

      const voiceContext = conversationModeRef.current 
         ? "MODO VOZ ATIVO: Responda de forma falada, fluida e natural. Evite listas longas. Seja direto."
         : "Responda em texto estruturado.";

      const systemPrompt = `
        ${IDENTITY_RULES}
        ${personaPrompt[persona] || personaPrompt['pro']}
        ${voiceContext}
        
        INSTRUÇÃO DE CORREÇÃO:
        - Se o input do usuário tiver erros (digitação, sentido), CORRIJA e responda à intenção correta.
        - Se estiver em outra língua, TRADUZA para Português de Portugal (PT-PT) mantendo o sentido.
      `;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: userMsg }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] }
        })
      });
      
      const data = await response.json();
      let aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Sistemas indisponíveis no momento.";
      
      if (!aiText.includes('[Código]')) {
         aiText = cleanText(aiText);
      }
      
      // CRÍTICO: Falar ANTES de salvar no banco para latência zero perceptível
      if (conversationModeRef.current) {
        speak(aiText);
      }

      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), {
        text: aiText,
        role: 'assistant',
        timestamp: Date.now(),
        uid: 'jarvis-ai',
        persona: persona
      });

    } catch (e) {
      addNotification("Jarvis Offline.", "error");
      if (conversationModeRef.current) fullStop();
    } finally {
      setIsTyping(false);
    }
  };

  const quickPrompts = {
    pro: ["Status do Sistema", "Resumo Executivo", "Análise de Dados", "Agenda 2026"],
    dev: ["Refatorar Código", "Debug Mode", "Arquitetura Cloud", "API Rest"],
    creative: ["Brainstorm", "Tendências 2026", "UX Design", "Copywriting"]
  };

  const downloadCode = () => {
    try {
      const fullHtml = `<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis Export - Playbox 2026</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <style>body { margin: 0; padding: 0; }</style>
</head>
<body>${currentCode}</body></html>`;
      
      const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `jarvis-playbox-export-${new Date().getTime()}.html`;
      document.body.appendChild(link);
      link.click();
      setTimeout(() => { document.body.removeChild(link); window.URL.revokeObjectURL(url); }, 100);
      addNotification("Exportação concluída.");
    } catch (error) {
      addNotification("Erro na exportação.", "error");
    }
  };

  const isDark = theme === 'dark';

  if (bootSequence) {
    return (
      <div className="h-screen w-screen bg-black flex flex-col items-center justify-center text-blue-500 font-mono text-xs overflow-hidden">
        <div className="w-64 h-1 bg-blue-900 rounded-full overflow-hidden mb-4 relative">
           <motion.div initial={{ width: 0 }} animate={{ width: "100%" }} transition={{ duration: 2 }} className="h-full bg-blue-400 absolute left-0 top-0" />
        </div>
        <div className="space-y-1 text-center tracking-widest">
          <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.2 }}>JARVIS IA • PLAYBOX</motion.div>
          <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.6 }} className="text-emerald-500">SYSTEM 2026 LOADED</motion.div>
          <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 1.5 }} className="text-purple-500">NEURAL ENGINE ACTIVE</motion.div>
        </div>
      </div>
    );
  }

  return (
    <div className={`flex h-screen w-screen overflow-hidden ${isDark ? 'bg-[#05070a] text-blue-100' : 'bg-slate-50 text-slate-900'} transition-all duration-500`}>
      
      {/* Background Ambience */}
      {isDark && (
        <div className="absolute inset-0 z-0 pointer-events-none overflow-hidden">
           <div className="absolute top-0 left-1/4 w-[500px] h-[500px] bg-blue-900/10 rounded-full blur-[120px] animate-pulse"></div>
           <div className="absolute bottom-0 right-1/4 w-[500px] h-[500px] bg-indigo-900/10 rounded-full blur-[120px] animate-pulse delay-700"></div>
        </div>
      )}
      
      {/* Telemetry Overlay */}
      <div className={`absolute top-0 right-0 p-4 font-mono text-[9px] pointer-events-none z-[60] transition-colors ${isDark ? 'text-slate-600' : 'text-slate-400'}`}>
         <div className="flex gap-4">
             <span>CPU: {telemetry.cpu}%</span>
             <span>MEM: {telemetry.ram}%</span>
             <span>LATENCY: {telemetry.net}ms</span>
             <span className="text-blue-500 font-bold">PLAYBOX // 2026</span>
         </div>
      </div>

      {/* Notifications */}
      <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[1000] flex flex-col gap-2 pointer-events-none">
        <AnimatePresence>
          {notifications.map(n => (
            <motion.div key={n.id} initial={{ opacity: 0, y: -20, scale: 0.9 }} animate={{ opacity: 1, y: 0, scale: 1 }} exit={{ opacity: 0, scale: 0.9 }} className={`px-5 py-2.5 rounded-full border shadow-2xl backdrop-blur-xl flex items-center gap-3 text-[11px] font-bold uppercase tracking-wide ${n.type === 'error' ? 'bg-red-500/10 border-red-500/40 text-red-400' : 'bg-blue-500/10 border-blue-500/40 text-blue-400'}`}>
              <div className={`w-2 h-2 rounded-full ${n.type === 'error' ? 'bg-red-500 animate-ping' : 'bg-blue-400 animate-pulse'}`}></div> {n.text}
            </motion.div>
          ))}
        </AnimatePresence>
      </div>

      {/* Main Sidebar */}
      {!fullPreview && (
        <nav className={`w-20 border-r ${isDark ? 'border-blue-500/10 bg-black/40' : 'border-slate-200 bg-white'} flex flex-col items-center py-6 gap-8 z-50 backdrop-blur-md`}>
          <div className="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20 cursor-pointer hover:scale-105 transition-all group" onClick={() => window.location.reload()}>
            <Cpu size={24} className="text-white group-hover:rotate-90 transition-transform duration-700"/>
          </div>
          <div className="flex flex-col gap-4 w-full px-4">
            <button onClick={() => setActiveTab('canvas')} className={`p-3 rounded-xl transition-all flex justify-center ${activeTab === 'canvas' ? 'bg-blue-500/10 text-blue-400 border border-blue-500/20 shadow-[0_0_20px_rgba(59,130,246,0.1)]' : 'text-slate-500 hover:text-blue-500 hover:bg-black/5 dark:hover:bg-white/5'}`} title="Canvas Pro"><Layout size={22}/></button>
            <button onClick={() => setActiveTab('chat')} className={`p-3 rounded-xl transition-all flex justify-center ${activeTab === 'chat' ? 'bg-blue-500/10 text-blue-400 border border-blue-500/20 shadow-[0_0_20px_rgba(59,130,246,0.1)]' : 'text-slate-500 hover:text-blue-500 hover:bg-black/5 dark:hover:bg-white/5'}`} title="Jarvis Chat"><MessageSquare size={22}/></button>
          </div>
          <div className="mt-auto flex flex-col gap-4 w-full px-4">
            <button onClick={() => setTheme(isDark ? 'light' : 'dark')} className="p-3 text-slate-500 hover:text-yellow-500 hover:rotate-180 transition-all flex justify-center">
              {isDark ? <Sun size={20}/> : <Moon size={20}/>}
            </button>
          </div>
        </nav>
      )}

      {/* Main Content Area */}
      <main className="flex-1 flex flex-col relative overflow-hidden">
        {activeTab === 'canvas' ? (
          <div className="flex-1 flex flex-col overflow-hidden">
            {!fullPreview && (
              <header className={`h-16 border-b ${isDark ? 'border-blue-500/10 bg-black/20' : 'border-slate-200 bg-white'} flex items-center justify-between px-6 z-30 backdrop-blur-sm`}>
                <div className="flex items-center gap-6">
                  <div className={`flex p-1.5 rounded-xl border ${isDark ? 'border-white/5 bg-black/40' : 'border-slate-200 bg-slate-100'}`}>
                    <button onClick={() => setMode('preview')} className={`px-5 py-1.5 text-[10px] font-black rounded-lg transition-all ${mode === 'preview' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-900 dark:hover:text-white'}`}>CANVAS</button>
                    <button onClick={() => setMode('code')} className={`px-5 py-1.5 text-[10px] font-black rounded-lg transition-all ${mode === 'code' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-900 dark:hover:text-white'}`}>EDITOR</button>
                  </div>
                  <div className={`flex p-1 rounded-lg border ${isDark ? 'border-white/5 bg-black/20' : 'border-slate-200'}`}>
                    <button onClick={() => setViewPort('desktop')} className={`p-2 rounded-md transition-all ${viewPort === 'desktop' ? 'text-blue-400 bg-blue-500/10' : 'text-slate-500 hover:text-blue-400'}`}><Monitor size={16}/></button>
                    <button onClick={() => setViewPort('mobile')} className={`p-2 rounded-md transition-all ${viewPort === 'mobile' ? 'text-blue-400 bg-blue-500/10' : 'text-slate-500 hover:text-blue-400'}`}><MobileIcon size={16}/></button>
                  </div>
                  {isSaving && <div className="text-[10px] text-emerald-400 font-black animate-pulse flex items-center gap-2"><Save size={12}/> SAVING</div>}
                </div>
                <div className="flex gap-3">
                   {!showHistory && (
                     <button onClick={() => setShowHistory(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-500/5 text-blue-500 border border-blue-500/20 rounded-lg text-[10px] font-black uppercase tracking-wider hover:bg-blue-500/10 transition-all">
                       <History size={14}/>
                     </button>
                   )}
                   <div className="h-8 w-[1px] bg-slate-500/20 mx-2"></div>
                   <button onClick={downloadCode} title="Exportar Projeto" className="p-2 text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/5 rounded-lg transition-all"><Download size={18}/></button>
                   <button onClick={() => setFullPreview(true)} title="Tela Cheia" className="p-2 text-slate-400 hover:text-blue-400 hover:bg-blue-500/5 rounded-lg transition-all"><Maximize size={18}/></button>
                </div>
              </header>
            )}

            <div className="flex-1 flex overflow-hidden relative bg-[url('[https://grainy-gradients.vercel.app/noise.svg](https://grainy-gradients.vercel.app/noise.svg)')] opacity-100">
              {fullPreview && <button onClick={() => setFullPreview(false)} className="fixed top-6 right-6 z-[100] w-12 h-12 bg-black/60 rounded-full flex items-center justify-center text-white border border-white/10 hover:scale-110 transition-all shadow-2xl backdrop-blur-md hover:bg-red-500/80"><X size={24}/></button>}
              
              <div className={`flex-1 flex items-center justify-center transition-all duration-700 ${fullPreview ? 'absolute inset-0 z-50 p-0' : 'p-8'}`}>
                
                <div className={`transition-all duration-500 shadow-2xl relative ${isDark ? 'bg-[#1e1e1e]' : 'bg-white'} 
                  ${!fullPreview && viewPort === 'mobile' ? 'w-[390px] h-[800px] rounded-[3rem] border-[8px] border-slate-800 shadow-[0_0_40px_rgba(0,0,0,0.5)]' : 'w-full h-full'} 
                  ${fullPreview ? 'w-full h-full rounded-none border-0' : 'rounded-2xl'} overflow-hidden flex flex-col group`}
                >
                  {/* Phone Notch/Bar */}
                  {!fullPreview && viewPort === 'mobile' && (
                    <div className="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-7 bg-slate-800 rounded-b-2xl z-20 flex items-center justify-center gap-2">
                       <div className="w-10 h-1 bg-slate-700 rounded-full"></div>
                       <div className="w-1 h-1 bg-blue-900 rounded-full"></div>
                    </div>
                  )}

                  {mode === 'preview' ? (
                    <iframe 
                      key={currentCode.length} 
                      className={`w-full h-full border-none ${!fullPreview && viewPort === 'mobile' ? 'mt-0 rounded-[2.5rem]' : ''}`}
                      srcDoc={`<!DOCTYPE html><html><head><script src="https://cdn.tailwindcss.com"></script><style>body{margin:0;overflow-x:hidden;}::-webkit-scrollbar{display:none;}</style></head><body>${currentCode}</body></html>`} 
                      title="Preview"
                    />
                  ) : (
                    <div className="flex flex-col h-full bg-[#0d1117] text-gray-300 relative">
                      <div className="flex items-center justify-between px-4 py-2 bg-[#010409] border-b border-gray-800 text-xs">
                         <span className="font-mono text-blue-400">index.html</span>
                         <button onClick={formatCode} className="flex items-center gap-2 text-[10px] hover:text-white"><AlignLeft size={12}/> Formatar</button>
                      </div>
                      <div className="flex flex-1 overflow-hidden">
                        {/* Line Numbers */}
                        <div className="w-10 bg-[#0d1117] border-r border-gray-800 pt-6 text-right pr-2 text-gray-600 font-mono text-xs select-none">
                            {currentCode.split('\n').map((_, i) => (
                                <div key={i} className="leading-relaxed">{i+1}</div>
                            ))}
                        </div>
                        <textarea 
                          ref={codeTextareaRef}
                          value={currentCode} 
                          onChange={(e) => setCurrentCode(e.target.value)} 
                          className="flex-1 w-full p-6 pt-6 font-mono text-xs bg-[#0d1117] text-blue-100 outline-none resize-none leading-relaxed" 
                          spellCheck="false"
                        />
                      </div>
                    </div>
                  )}
                  {isBuilding && (
                    <div className="absolute inset-0 bg-[#05070a]/80 backdrop-blur-md flex flex-col items-center justify-center z-50 text-blue-400">
                      <div className="relative">
                        <div className="absolute inset-0 bg-blue-500 blur-xl opacity-20 animate-pulse"></div>
                        <Activity size={48} className="animate-spin relative z-10"/>
                      </div>
                      <span className="text-[10px] font-black uppercase tracking-[0.3em] mt-6 animate-pulse">Gerando Interface</span>
                    </div>
                  )}
                </div>
              </div>

              {/* History Sidebar */}
              {!fullPreview && (
                <AnimatePresence>
                  {showHistory && (
                    <motion.aside 
                      initial={{ x: 320, opacity: 0 }}
                      animate={{ x: 0, opacity: 1 }}
                      exit={{ x: 320, opacity: 0 }}
                      transition={{ type: "spring", damping: 25, stiffness: 200 }}
                      className={`w-80 border-l ${isDark ? 'border-blue-500/10 bg-black/60 backdrop-blur-xl' : 'border-slate-200 bg-white/90'} flex flex-col relative z-40 shadow-[-10px_0_30px_rgba(0,0,0,0.2)]`}
                    >
                      <div className="p-5 border-b border-inherit flex items-center justify-between">
                        <span className="text-[10px] font-black tracking-[0.2em] text-blue-500 uppercase flex items-center gap-2">
                           <Database size={12}/> Memória
                        </span>
                        <button onClick={() => setShowHistory(false)} className="p-1.5 hover:bg-white/10 rounded-full transition-colors text-slate-500 hover:text-white"><ChevronRightIcon size={16}/></button>
                      </div>
                      
                      <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                        {canvasHistory.map((v, idx) => (
                          <motion.div 
                            initial={{ opacity: 0, x: 20 }}
                            animate={{ opacity: 1, x: 0 }}
                            transition={{ delay: idx * 0.05 }}
                            whileHover={{ scale: 1.02, x: 5 }}
                            key={v.id} 
                            onClick={() => {
                              setCurrentCode(v.code);
                              addNotification("Versão restaurada.", "success");
                            }} 
                            className={`group p-3 rounded-xl border cursor-pointer transition-all relative overflow-hidden ${isDark ? 'border-blue-500/10 bg-blue-500/5 hover:bg-blue-600/10' : 'border-slate-200 bg-white hover:border-blue-400'}`}
                          >
                            <div className={`text-[11px] font-bold truncate mb-1 ${isDark ? 'text-blue-300' : 'text-slate-800'}`}>{v.name || 'Estado Gravado'}</div>
                            <div className="text-[9px] opacity-40 font-mono flex items-center gap-2 text-slate-500">
                              <div className="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                              {new Date(v.timestamp).toLocaleTimeString()}
                            </div>
                          </motion.div>
                        ))}
                      </div>

                      <div className={`h-48 border-t border-inherit p-4 font-mono text-[9px] overflow-y-auto custom-scrollbar ${isDark ? 'bg-black/40' : 'bg-slate-50'}`}>
                        <div className="flex items-center gap-2 mb-2 text-slate-500 font-bold uppercase tracking-wider opacity-50"><Terminal size={10}/> Playbox Logs</div>
                        {logs.map(l => (
                          <div key={l.id} className={`mb-1.5 break-words ${l.type === 'error' ? 'text-red-400' : l.type === 'success' ? 'text-emerald-500' : 'text-slate-500'}`}>
                            <span className="opacity-30 mr-2">[{l.time}]</span>
                            {l.msg.replace('JARVIS:', '')}
                          </div>
                        ))}
                        <div ref={logsEndRef}/>
                      </div>
                    </motion.aside>
                  )}
                </AnimatePresence>
              )}
            </div>

            {!fullPreview && (
              <div className={`p-6 border-t ${isDark ? 'border-blue-500/10 bg-[#020408]' : 'border-slate-200 bg-white'} relative z-50`}>
                <div className={`max-w-4xl mx-auto flex gap-2 p-1.5 pl-5 rounded-2xl border transition-all duration-300 ${isDark ? 'border-blue-500/20 bg-[#0d1117] focus-within:border-blue-500/60' : 'border-slate-200 bg-slate-50 shadow-inner'}`}>
                  <input 
                    value={input} 
                    onChange={(e) => setInput(e.target.value)} 
                    onKeyDown={(e) => e.key === 'Enter' && handleGenerateCode()} 
                    placeholder="Descreva a interface desejada..." 
                    className={`flex-1 bg-transparent py-3 text-sm outline-none font-medium ${isDark ? 'placeholder:text-slate-600 text-white' : 'placeholder:text-slate-400 text-slate-800'}`} 
                  />
                  <div className="flex items-center gap-2 pr-2">
                    <button 
                       onClick={toggleDictation} 
                       className={`p-3 rounded-xl transition-all flex items-center gap-2 ${isDictating ? 'bg-blue-500/20 text-blue-500' : (isDark ? 'text-slate-500 hover:bg-white/10 hover:text-white' : 'text-slate-400 hover:bg-slate-100 hover:text-slate-700')}`}
                       title="Voz para Código"
                    >
                      {isDictating ? <AudioVisualizer isActive={true} /> : <Mic size={18}/>}
                    </button>
                    <button 
                      onClick={() => handleGenerateCode()} 
                      className="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 hover:scale-105 transition-all active:scale-95 flex items-center gap-2"
                    >
                      <Wand2 size={14}/> Criar
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        ) : (
          /* --- CHAT MODE (JARVIS 2026) --- */
          <div className={`flex-1 flex flex-col overflow-hidden relative ${isDark ? 'bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#05070a] to-black text-white' : 'bg-slate-50 text-slate-900'}`}>
            {!isDark && <GridBackground />}
            
            <header className={`h-20 border-b ${isDark ? 'border-blue-500/10 bg-black/20 text-white' : 'border-slate-200 bg-white/80 text-slate-900'} flex items-center justify-between px-10 backdrop-blur-md relative z-10`}>
               {isSpeaking && <motion.div initial={{ width: 0 }} animate={{ width: "100%" }} transition={{ duration: 3, ease: "linear" }} className="absolute top-0 left-0 h-[2px] bg-blue-500" />}

               <div className="flex items-center gap-6">
                 <div className="relative">
                   <div className={`w-3 h-3 rounded-full shadow-[0_0_15px_rgba(34,197,94,0.6)] animate-pulse ${conversationMode ? 'bg-red-500' : 'bg-green-500'}`} />
                   <div className={`absolute inset-0 rounded-full animate-ping opacity-20 ${conversationMode ? 'bg-red-400' : 'bg-green-400'}`}></div>
                 </div>
                 <div className="flex flex-col">
                   <span className={`text-[12px] font-black tracking-[0.2em] uppercase ${isDark ? 'text-white' : 'text-slate-900'}`}>JARVIS IA</span>
                   <span className="text-[9px] font-mono text-blue-500 flex gap-2">
                     PLAYBOX • 2026 • {conversationMode ? <span className="text-red-400 animate-pulse">VOICE LIVE</span> : 'ONLINE'} 
                   </span>
                 </div>
               </div>
               
               <div className={`flex p-1 rounded-xl border gap-1 ${isDark ? 'bg-black/30 border-white/5' : 'bg-slate-100 border-slate-200'}`}>
                 {[
                   {id: 'pro', icon: <Briefcase size={12}/>}, 
                   {id: 'dev', icon: <Code2 size={12}/>}, 
                   {id: 'creative', icon: <Sparkles size={12}/>}
                 ].map(p => (
                   <button key={p.id} onClick={() => setPersona(p.id)} title={p.id.toUpperCase()} className={`p-2 px-3 text-[10px] font-bold rounded-lg border transition-all uppercase tracking-wide flex items-center gap-2 ${persona === p.id ? 'border-blue-500 bg-blue-600/20 text-blue-500 shadow-sm' : 'border-transparent text-slate-500 hover:text-slate-700'}`}>
                     {p.icon} <span className="hidden md:inline">{p.id}</span>
                   </button>
                 ))}
               </div>
            </header>

            <div className="flex-1 overflow-y-auto p-8 md:p-16 space-y-10 custom-scrollbar scroll-smooth relative z-0">
              {messages.length === 0 && (
                <div className="flex flex-col items-center justify-center py-20 text-center space-y-8 opacity-0 animate-[fadeIn_1s_ease-out_forwards]">
                  <div className="relative group">
                    <div className="absolute inset-0 bg-blue-500/20 blur-[50px] rounded-full group-hover:bg-blue-500/30 transition-all duration-1000" />
                    <div className={`relative w-32 h-32 rounded-full flex items-center justify-center border shadow-xl ${isDark ? 'bg-gradient-to-b from-blue-900/40 to-black/40 border-blue-500/30' : 'bg-white border-blue-100'}`}>
                      <Bot size={48} className="text-blue-500 animate-pulse"/>
                    </div>
                  </div>
                  <div>
                    <h2 className={`text-4xl font-black tracking-tighter text-transparent bg-clip-text ${isDark ? 'bg-gradient-to-r from-blue-200 to-indigo-200' : 'bg-gradient-to-r from-blue-600 to-indigo-600'}`}>JARVIS IA</h2>
                    <p className="text-slate-400 text-[11px] uppercase tracking-[0.3em] mt-4 font-medium">PLAYBOX • 2026</p>
                  </div>
                </div>
              )}
              
              {messages.map((m, i) => (
                <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ type: "spring", damping: 20 }} key={i} className={`flex gap-6 ${m.role === 'assistant' ? '' : 'flex-row-reverse'}`}>
                  <div className={`w-10 h-10 rounded-full flex items-center justify-center border shadow-lg shrink-0 ${m.role === 'assistant' ? 'bg-gradient-to-br from-blue-600 to-blue-800 border-blue-400/30 text-white' : (isDark ? 'bg-slate-800 border-slate-600 text-slate-300' : 'bg-white border-slate-200 text-slate-600')}`}>
                    {m.role === 'assistant' ? <Bot size={18}/> : <User size={18}/>}
                  </div>
                  <div className={`flex flex-col gap-2 ${m.role === 'assistant' ? 'items-start max-w-3xl' : 'items-end max-w-xl'}`}>
                    <div className={`px-8 py-5 rounded-[2rem] text-sm leading-relaxed shadow-lg backdrop-blur-sm whitespace-pre-wrap font-medium ${m.role === 'assistant' ? (isDark ? 'bg-white/5 border border-white/10 text-slate-200 rounded-tl-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none') : 'bg-blue-600 text-white shadow-blue-600/20 rounded-tr-none'}`}>
                      {m.role === 'assistant' ? <TypewriterText text={m.text} speed={10} animate={Date.now() - m.timestamp < 10000} /> : m.text}
                    </div>
                    {m.role === 'assistant' && (
                      <div className="flex gap-4 px-4 opacity-50 hover:opacity-100 transition-opacity">
                        <button onClick={() => { setActiveTab('canvas'); handleGenerateCode(m.text); }} className="flex items-center gap-1.5 text-[10px] font-black text-blue-500 hover:text-blue-400 uppercase tracking-wider transition-colors"><FileCode size={12}/> Canvas</button>
                        <button onClick={() => { navigator.clipboard.writeText(m.text); addNotification("Copiado."); }} className="flex items-center gap-1.5 text-[10px] font-black text-slate-400 hover:text-blue-400 uppercase tracking-wider transition-colors"><Copy size={12}/> Copiar</button>
                        <button onClick={() => speak(m.text)} className="flex items-center gap-1.5 text-[10px] font-black text-slate-400 hover:text-blue-400 uppercase tracking-wider transition-colors"><Volume2 size={12}/> Reouvir</button>
                      </div>
                    )}
                  </div>
                </motion.div>
              ))}

              {isTyping && (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex gap-6">
                   <div className="w-10 h-10 rounded-full flex items-center justify-center bg-blue-600 text-white shadow-lg shrink-0">
                      <Bot size={18}/>
                   </div>
                   <div className={`px-6 py-4 rounded-[2rem] rounded-tl-none flex items-center gap-1 ${isDark ? 'bg-white/5 border border-white/10' : 'bg-white border border-slate-200 shadow-md'}`}>
                      <motion.div animate={{ scale: [1, 1.2, 1] }} transition={{ repeat: Infinity, duration: 1 }} className="w-2 h-2 bg-blue-500 rounded-full" />
                      <motion.div animate={{ scale: [1, 1.2, 1] }} transition={{ repeat: Infinity, duration: 1, delay: 0.2 }} className="w-2 h-2 bg-blue-500 rounded-full" />
                      <motion.div animate={{ scale: [1, 1.2, 1] }} transition={{ repeat: Infinity, duration: 1, delay: 0.4 }} className="w-2 h-2 bg-blue-500 rounded-full" />
                   </div>
                </motion.div>
              )}

              <div ref={chatEndRef} />
            </div>

            <div className={`p-6 border-t border-inherit ${isDark ? 'bg-black/40 backdrop-blur-md' : 'bg-white/80'}`}>
              
              <div className="flex gap-2 overflow-x-auto pb-4 max-w-4xl mx-auto custom-scrollbar">
                  {quickPrompts[persona].map((qp, i) => (
                    <button key={i} onClick={() => handleChatSend(qp)} className={`whitespace-nowrap px-4 py-2 border rounded-full text-[10px] font-bold transition-all flex items-center gap-2 ${isDark ? 'bg-blue-500/10 border-blue-500/20 text-blue-400 hover:bg-blue-500/20' : 'bg-blue-50 border-blue-200 text-blue-600 hover:bg-blue-100 shadow-sm'}`}>
                       <Zap size={10}/> {qp}
                    </button>
                  ))}
              </div>

              <div className={`max-w-4xl mx-auto flex gap-3 p-2 pl-6 rounded-[2rem] border transition-all ${isDark ? 'border-blue-500/20 bg-[#0a0d14] hover:border-blue-500/40 focus-within:border-blue-500/60' : 'border-slate-200 bg-white hover:border-blue-300 focus-within:border-blue-500 focus-within:shadow-lg'} relative`}>
                <input 
                   value={chatInput} 
                   onChange={(e) => setChatInput(e.target.value)} 
                   onKeyDown={(e) => e.key === 'Enter' && !isTyping && handleChatSend()} 
                   placeholder={
                     conversationMode ? "Modo Voz Ativo (Fale com o Jarvis...)" :
                     isDictating ? "Ouvindo... (Fale para digitar)" :
                     `Digite um comando para Jarvis ${persona.toUpperCase()}...`
                   }
                   className={`flex-1 bg-transparent py-4 text-sm outline-none font-medium ${isDark ? 'placeholder:text-slate-600 text-white' : 'placeholder:text-slate-400 text-slate-800'}`}
                   disabled={isTyping} 
                />
                
                {conversationMode && (
                   <div className="absolute -top-12 left-1/2 -translate-x-1/2 bg-red-500/20 text-red-400 border border-red-500/40 px-6 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest flex items-center gap-3 animate-pulse backdrop-blur-md z-10 shadow-xl">
                      <div className="w-2 h-2 bg-red-500 rounded-full animate-ping"></div> 
                      {isSpeaking ? "JARVIS FALANDO" : "MIC ABERTO"}
                   </div>
                )}
                
                {(isSpeaking || conversationMode || isDictating) && (
                    <div className="absolute -top-12 right-0 bg-red-500 text-white px-4 py-1.5 rounded-full text-[10px] font-bold cursor-pointer hover:bg-red-600 shadow-lg flex items-center gap-2 animate-in fade-in zoom-in" onClick={fullStop}>
                        <StopCircle size={14} /> PARAR
                    </div>
                )}

                <div className="flex items-center pr-2 gap-2">
                   <button 
                      onClick={toggleConversationMode} 
                      className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${conversationMode ? 'bg-red-500 text-white shadow-[0_0_15px_rgba(239,68,68,0.5)]' : (isDark ? 'text-slate-500 hover:bg-white/10 hover:text-white' : 'text-slate-400 hover:bg-slate-100 hover:text-slate-700')}`}
                      title="Modo Voz (Conversa)"
                   >
                     {conversationMode ? <MicOff size={18}/> : <Headphones size={20}/>}
                   </button>
                   
                   {!conversationMode && (
                       <button 
                          onClick={toggleDictation} 
                          className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${isDictating ? 'bg-blue-500/20 text-blue-500 ring-2 ring-blue-500/50' : (isDark ? 'text-slate-500 hover:bg-white/10 hover:text-white' : 'text-slate-400 hover:bg-slate-100 hover:text-slate-700')}`}
                          title="Digitação por Voz"
                       >
                         {isDictating ? <AudioVisualizer isActive={true} /> : <Mic size={20}/>}
                       </button>
                   )}

                   <button 
                      onClick={() => handleChatSend()} 
                      className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${isTyping || !chatInput.trim() ? (isDark ? 'bg-slate-800 text-slate-600' : 'bg-slate-200 text-slate-400') : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-600/30 hover:scale-105 active:scale-95'}`} 
                      disabled={isTyping || !chatInput.trim()}
                   >
                     {isTyping ? <RefreshCw className="animate-spin" size={20}/> : <Send size={20}/>}
                   </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </main>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(59,130,246,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(59,130,246,0.3); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      `}</style>
    </div>
  );
};

export default App;
